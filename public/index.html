<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FoodLog AI – API Tester</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    body { font-family: -apple-system, Roboto, Arial; padding: 18px; background: #0f172a; color: #fff; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .box { background:#111827; padding:12px; border-radius:10px; margin-bottom:12px; border:1px solid #1f2937; }
    button { padding:10px 12px; border-radius:8px; border:none; cursor:pointer; background:#3b82f6; color:#fff; }
    pre { background:#0b1220; padding:10px; border-radius:8px; overflow:auto; color:#d1d5db; }
    select, input[type=file], input[type=number] { width:100%; margin-top:8px; margin-bottom:8px; padding:8px; border-radius:8px; background:#0b1220; color:#fff; border:1px solid #1f2937; }
    .portion-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .portion-row div { display: flex; flex-direction: column; }
    .portion-row label { margin-bottom: 4px; font-size: 13px; color: #cbd5e1; }
    .portion-row input { margin: 0; }
  </style>
</head>
<body>
  <h1>FoodLog AI – API Tester</h1>

  <div class="box">
    <label><strong>Upload photo</strong></label>
    <input id="fileInput" type="file" accept="image/*">
    <button id="visionBtn">Recognize (OpenAI Vision)</button>
    <p id="detected" style="margin-top:8px;color:#cbd5e1"></p>
  </div>

  <div class="box">
    <label><strong>Portion Size</strong></label>
    <div class="portion-row">
      <div>
        <label>Amount</label>
        <input id="portionInput" type="number" value="100" min="10" max="5000" step="10">
      </div>
      <div>
        <label>Unit</label>
        <select id="unitSelect">
          <option value="g">grams (g)</option>
          <option value="oz">ounces (oz)</option>
          <option value="cup">cups</option>
          <option value="serving">servings</option>
        </select>
      </div>
    </div>
  </div>

  <div class="box">
    <label><strong>Select tab (nutrition provider)</strong></label>
    <select id="tabSelect">
      <option value="1">Tab 1 – Edamam Nutrition</option>
      <option value="2">Tab 2 – Edamam Food DB</option>
      <option value="3">Tab 3 – FatSecret</option>
      <option value="4">Tab 4 – OpenFoodFacts</option>
      <option value="5">Tab 5 – Spoonacular</option>
      <option value="6">Tab 6 – OpenAI Nutrition</option>
    </select>
    <button id="getNutritionBtn">Get Nutrition for detected food</button>
    <pre id="resultPre">No result yet</pre>
  </div>

  <script>
    const visionBtn = document.getElementById('visionBtn');
    const getNutritionBtn = document.getElementById('getNutritionBtn');
    const fileInput = document.getElementById('fileInput');
    const detected = document.getElementById('detected');
    const resultPre = document.getElementById('resultPre');
    const tabSelect = document.getElementById('tabSelect');
    const portionInput = document.getElementById('portionInput');
    const unitSelect = document.getElementById('unitSelect');

    let lastFoodName = '';

    // Convert any unit to grams
    function convertToGrams(amount, unit) {
      const conversions = {
        'g': 1,
        'oz': 28.35,
        'cup': 240,
        'serving': 100
      };
      return amount * (conversions[unit] || 1);
    }

    // Scale nutrition by portion size
    function scaleNutrition(nutrition, portionGrams) {
      const scale = portionGrams / 100;
      return {
        calories: Math.round(nutrition.calories * scale * 10) / 10,
        protein: Math.round(nutrition.protein * scale * 10) / 10,
        carbs: Math.round(nutrition.carbs * scale * 10) / 10,
        fat: Math.round(nutrition.fat * scale * 10) / 10
      };
    }

    visionBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return alert('Please choose an image first');
      const fd = new FormData();
      fd.append('image', file);

      detected.textContent = 'Recognizing...';
      try {
        const r = await fetch('/api/openai/vision', { method: 'POST', body: fd });
        const data = await r.json();
        if (data.error) {
          detected.textContent = 'Error: ' + data.error;
          return;
        }
        lastFoodName = data.foodName;
        detected.textContent = 'Detected: ' + lastFoodName;
      } catch (err) {
        detected.textContent = 'Failed: ' + err.message;
      }
    });

    getNutritionBtn.addEventListener('click', async () => {
      const tab = tabSelect.value;
      if (!lastFoodName) return alert('Recognize an image first (button above)');
      
      const portionGrams = convertToGrams(portionInput.value, unitSelect.value);
      resultPre.textContent = 'Fetching nutrition...';
      
      try {
        const res = await fetch(`/api/nutrition/${tab}?q=${encodeURIComponent(lastFoodName)}`);
        const data = await res.json();
        if (data.error) {
          resultPre.textContent = 'Error: ' + data.error;
        } else {
          const scaled = scaleNutrition(data.nutrition, portionGrams);
          const result = {
            foodName: data.foodName,
            portionSize: `${portionInput.value} ${unitSelect.value} (${Math.round(portionGrams)}g)`,
            nutritionScaled: scaled,
            nutritionPer100g: data.nutrition
          };
          resultPre.textContent = JSON.stringify(result, null, 2);
        }
      } catch (err) {
        resultPre.textContent = 'Failed: ' + err.message;
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
