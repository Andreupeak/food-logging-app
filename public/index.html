<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FoodLog AI — API Tester</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    body { font-family: -apple-system, Roboto, Arial; padding: 18px; background: #0f172a; color: #fff; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .box { background:#111827; padding:12px; border-radius:10px; margin-bottom:12px; border:1px solid #1f2937; }
    button { padding:10px 12px; border-radius:8px; border:none; cursor:pointer; background:#3b82f6; color:#fff; }
    pre { background:#0b1220; padding:10px; border-radius:8px; overflow:auto; color:#d1d5db; }
    select, input[type=file] { width:100%; margin-top:8px; margin-bottom:8px; padding:8px; border-radius:8px; background:#0b1220; color:#fff; border:1px solid #1f2937; }
  </style>
</head>
<body>
  <h1>FoodLog AI — API Tester</h1>

  <div class="box">
    <label><strong>Upload photo</strong></label>
    <input id="fileInput" type="file" accept="image/*">
    <button id="visionBtn">Recognize (OpenAI Vision)</button>
    <p id="detected" style="margin-top:8px;color:#cbd5e1"></p>
  </div>

  <div class="box">
    <label><strong>Select tab (nutrition provider)</strong></label>
    <select id="tabSelect">
      <option value="1">Tab 1 — Edamam Nutrition</option>
      <option value="2">Tab 2 — Edamam Food DB</option>
      <option value="3">Tab 3 — FatSecret</option>
      <option value="4">Tab 4 — OpenFoodFacts</option>
      <option value="5">Tab 5 — Spoonacular</option>
      <option value="6">Tab 6 — OpenAI Nutrition</option>
    </select>
    <button id="getNutritionBtn">Get Nutrition for detected food</button>
    <pre id="resultPre">No result yet</pre>
  </div>

  <script>
    const visionBtn = document.getElementById('visionBtn');
    const getNutritionBtn = document.getElementById('getNutritionBtn');
    const fileInput = document.getElementById('fileInput');
    const detected = document.getElementById('detected');
    const resultPre = document.getElementById('resultPre');
    const tabSelect = document.getElementById('tabSelect');

    let lastFoodName = '';

    visionBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return alert('Please choose an image first');
      const fd = new FormData();
      fd.append('image', file);

      detected.textContent = 'Recognizing...';
      try {
        const r = await fetch('/api/openai/vision', { method: 'POST', body: fd });
        const data = await r.json();
        if (data.error) {
          detected.textContent = 'Error: ' + data.error;
          return;
        }
        lastFoodName = data.foodName;
        detected.textContent = 'Detected: ' + lastFoodName;
      } catch (err) {
        detected.textContent = 'Failed: ' + err.message;
      }
    });

    getNutritionBtn.addEventListener('click', async () => {
      const tab = tabSelect.value;
      if (!lastFoodName) return alert('Recognize an image first (button above)');
      resultPre.textContent = 'Fetching nutrition...';
      try {
        const res = await fetch(`/api/nutrition/${tab}?q=${encodeURIComponent(lastFoodName)}`);
        const data = await res.json();
        if (data.error) {
          resultPre.textContent = 'Error: ' + data.error;
        } else {
          resultPre.textContent = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        resultPre.textContent = 'Failed: ' + err.message;
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
